<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#FFF5E6">
<title>è²§ä¹ã‚¹ã‚­ãƒ£ãƒ³</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;800&family=Dela+Gothic+One&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#FFF8F0;--bg2:#FFFFFF;--bg3:#FFF0E0;
  --text:#2D2A26;--dim:#8A8480;--white:#fff;
  --pink:#FF6B8A;--orange:#FF8C42;--yellow:#FFD166;
  --green:#06D6A0;--blue:#4ECDC4;--purple:#A88BEB;
  --red:#FF5757;
  --cat-s:#FF6B8A;--cat-c:#FF8C42;--cat-r:#4ECDC4;--cat-e:#FFD166;--cat-m:#A88BEB;
  --shadow:0 4px 20px rgba(0,0,0,.06);
  --shadow-lg:0 8px 32px rgba(0,0,0,.1);
  --round:'M PLUS Rounded 1c',sans-serif;
  --display:'Dela Gothic One',sans-serif;
  --radius:16px;--radius-sm:10px;
}
html{background:var(--bg);scroll-behavior:smooth}
body{font-family:var(--round);color:var(--text);overflow-x:hidden;
  -webkit-tap-highlight-color:transparent;font-size:15px;line-height:1.7;min-height:100dvh}

/* ===== SCREEN ===== */
.scr{display:none;flex-direction:column;align-items:center;min-height:100dvh;padding:1.5rem 1.2rem 3rem}
.scr.on{display:flex;animation:popIn .5s cubic-bezier(.34,1.56,.64,1) forwards}
@keyframes popIn{from{opacity:0;transform:scale(.96) translateY(10px)}to{opacity:1;transform:scale(1) translateY(0)}}

/* ===== PROGRESS ===== */
#prog{position:fixed;top:0;left:0;height:4px;border-radius:0 4px 4px 0;z-index:999;
  background:linear-gradient(90deg,var(--pink),var(--orange),var(--yellow),var(--green),var(--blue));
  transition:width .4s cubic-bezier(.25,.8,.25,1)}

/* ===== COMMON ===== */
.spacer{flex:1}
.title-pop{font-family:var(--display);font-size:2rem;text-align:center;
  background:linear-gradient(135deg,var(--pink),var(--orange));-webkit-background-clip:text;
  -webkit-text-fill-color:transparent;background-clip:text;margin-bottom:.3rem}
.title-sub{font-size:.82rem;color:var(--dim);text-align:center;letter-spacing:.1em;margin-bottom:1.5rem;font-weight:700}
.narr{font-size:.95rem;line-height:1.9;text-align:center;color:var(--text);max-width:360px;margin-bottom:1.5rem}
.label{font-size:.7rem;font-weight:800;letter-spacing:.15em;margin-bottom:.8rem;text-transform:uppercase}

.card{background:var(--bg2);border-radius:var(--radius);box-shadow:var(--shadow);
  padding:1.2rem;width:100%;max-width:400px;margin-bottom:1rem}
.card-accent{border-left:4px solid var(--pink)}

.btn{display:inline-flex;align-items:center;justify-content:center;gap:.5rem;
  background:linear-gradient(135deg,var(--pink),var(--orange));color:#fff;
  border:none;border-radius:50px;font-family:var(--round);font-weight:800;font-size:.95rem;
  padding:.9rem 2.2rem;cursor:pointer;transition:all .2s;box-shadow:0 4px 15px rgba(255,107,138,.3);
  letter-spacing:.05em}
.btn:active{transform:scale(.96);box-shadow:0 2px 8px rgba(255,107,138,.2)}
.btn-outline{background:transparent;color:var(--pink);border:2px solid var(--pink);
  box-shadow:none}
.btn-outline:active{background:rgba(255,107,138,.08)}
.btn-sm{font-size:.82rem;padding:.65rem 1.5rem}
.btn-ghost{background:transparent;color:var(--dim);border:none;box-shadow:none;font-size:.82rem;
  text-decoration:underline;padding:.5rem 1rem}
.btn[disabled],.btn.disabled{opacity:.35;pointer-events:none}

.emoji-big{font-size:3rem;margin-bottom:.8rem}
.tag{display:inline-block;font-size:.7rem;font-weight:800;padding:.25rem .7rem;
  border-radius:50px;color:#fff;margin:.15rem}

.scene-label{font-size:.72rem;font-weight:800;color:var(--dim);letter-spacing:.2em;margin-bottom:.8rem}

/* ===== PROFILE SELECT ===== */
.profile-group{margin-bottom:1.3rem;width:100%}
.profile-group-label{font-size:.82rem;font-weight:800;color:var(--text);margin-bottom:.5rem}
.profile-opts{display:flex;flex-wrap:wrap;gap:.4rem}
.profile-opt{background:var(--bg3);border:2px solid transparent;border-radius:var(--radius-sm);
  font-size:.8rem;font-weight:700;padding:.5rem .8rem;cursor:pointer;transition:all .2s;
  color:var(--dim);font-family:var(--round)}
.profile-opt:active,.profile-opt.sel{border-color:var(--orange);color:var(--orange);background:#FFF5E6}

/* ===== QUESTIONS ===== */
.q-card{background:var(--bg2);border-radius:var(--radius);box-shadow:var(--shadow);
  padding:1.1rem;width:100%;max-width:400px;margin-bottom:.8rem;
  border-left:4px solid var(--dim);transition:border-color .3s}
.q-card.answered{border-left-color:var(--green)}
.q-num{font-size:.7rem;font-weight:800;color:var(--dim);margin-bottom:.3rem}
.q-text{font-size:.88rem;font-weight:700;line-height:1.7;margin-bottom:.7rem}
.q-opts{display:flex;gap:.4rem}
.q-opt{flex:1;background:var(--bg);border:2px solid transparent;border-radius:var(--radius-sm);
  font-size:.78rem;font-weight:700;padding:.55rem .3rem;text-align:center;cursor:pointer;
  transition:all .2s;color:var(--dim);font-family:var(--round)}
.q-opt:active,.q-opt.sel{border-color:var(--green);color:var(--green);background:rgba(6,214,160,.06)}

.cat-header{display:flex;align-items:center;gap:.5rem;margin-bottom:1rem;margin-top:.5rem;
  width:100%;max-width:400px}
.cat-dot{width:10px;height:10px;border-radius:50%}
.cat-name{font-size:.85rem;font-weight:800;letter-spacing:.05em}
.cat-count{font-size:.7rem;color:var(--dim);margin-left:auto;font-weight:700}

/* ===== RESULT ===== */
.res-type-badge{display:inline-block;padding:.5rem 1.5rem;border-radius:50px;
  font-family:var(--display);font-size:1.1rem;color:#fff;margin-bottom:.5rem;
  box-shadow:0 4px 15px rgba(0,0,0,.15)}
.res-headline{font-family:var(--display);font-size:1rem;text-align:center;margin-bottom:1.5rem;
  line-height:1.6}

.bar-row{display:flex;align-items:center;gap:.5rem;margin-bottom:.6rem}
.bar-icon{font-size:1rem;width:28px;text-align:center}
.bar-label{font-size:.72rem;font-weight:800;width:40px;color:var(--dim)}
.bar-track{flex:1;height:10px;background:var(--bg);border-radius:5px;overflow:hidden}
.bar-fill{height:100%;border-radius:5px;transition:width .8s cubic-bezier(.25,.8,.25,1)}
.bar-level{font-size:.68rem;font-weight:800;width:40px;text-align:right}

.action-card{background:var(--bg2);border-radius:var(--radius);box-shadow:var(--shadow);
  padding:1rem;margin-bottom:.8rem;width:100%;max-width:400px;border-left:4px solid var(--green)}
.action-num{font-size:.65rem;font-weight:800;color:var(--green);margin-bottom:.2rem}
.action-title{font-size:.9rem;font-weight:800;margin-bottom:.3rem}
.action-detail{font-size:.8rem;color:var(--dim);line-height:1.6;margin-bottom:.2rem}
.action-why{font-size:.75rem;color:var(--orange);font-weight:700}

.disclaimer{font-size:.72rem;color:var(--dim);text-align:center;line-height:1.7;
  max-width:360px;margin-top:1.5rem;padding-top:1rem;border-top:1px solid rgba(0,0,0,.06)}

/* ===== LOGIN AREA ===== */
.login-area{display:flex;flex-direction:column;align-items:center;gap:.5rem;margin-bottom:1.5rem}
.login-google{display:flex;align-items:center;gap:.6rem;background:#fff;border:2px solid #ddd;
  border-radius:50px;padding:.7rem 1.5rem;font-size:.85rem;font-weight:700;cursor:pointer;
  transition:all .2s;font-family:var(--round);color:var(--text)}
.login-google:hover{border-color:#4285F4;box-shadow:0 2px 10px rgba(66,133,244,.15)}
.login-google svg{width:18px;height:18px}
.login-status{font-size:.75rem;color:var(--green);font-weight:700}

/* ===== TOAST ===== */
.toast{position:fixed;bottom:1.5rem;left:50%;transform:translateX(-50%) translateY(20px);
  background:var(--text);color:#fff;border-radius:50px;padding:.6rem 1.5rem;font-size:.8rem;
  font-weight:700;opacity:0;transition:all .3s;z-index:1000;white-space:nowrap}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

/* ===== CONFETTI ===== */
.confetti-wrap{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:998;overflow:hidden}
.confetti{position:absolute;width:10px;height:10px;border-radius:2px;animation:confettiFall 2.5s ease-in forwards}
@keyframes confettiFall{
  0%{transform:translateY(-20px) rotate(0deg);opacity:1}
  100%{transform:translateY(110vh) rotate(720deg);opacity:0}
}

/* ===== BG DECO ===== */
.bg-circle{position:fixed;border-radius:50%;pointer-events:none;z-index:-1}
.bg-c1{width:300px;height:300px;top:-80px;right:-100px;background:rgba(255,107,138,.06)}
.bg-c2{width:250px;height:250px;bottom:-60px;left:-80px;background:rgba(78,205,196,.06)}
.bg-c3{width:200px;height:200px;top:40%;right:-60px;background:rgba(255,209,102,.06)}
</style>
</head>
<body>

<div class="bg-circle bg-c1"></div>
<div class="bg-circle bg-c2"></div>
<div class="bg-circle bg-c3"></div>
<div id="prog" style="width:0%"></div>
<div id="toast" class="toast"></div>

<!-- ========== 1. START ========== -->
<div class="scr on" id="s-start">
  <div class="spacer"></div>
  <div class="emoji-big">ğŸ”</div>
  <div class="title-pop">è²§ä¹ã‚¹ã‚­ãƒ£ãƒ³</div>
  <div class="title-sub">æ§‹é€ è¨ºæ–­ v1.0</div>
  <p class="narr">ã€Œè²§ä¹ã€ã¯æ€§æ ¼ã˜ã‚ƒãªã„ã€‚<br>æ§‹é€ ã®å•é¡Œã ã€‚<br><br>30ã®è³ªå•ã§ã€ã‚ãªãŸã®<br>ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã‚’ç‰¹å®šã™ã‚‹ã€‚</p>
  <div class="login-area">
    <button class="login-google" id="loginBtn" onclick="googleLogin()">
      <svg viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
      Googleã§ãƒ­ã‚°ã‚¤ãƒ³
    </button>
    <div class="login-status" id="loginStatus"></div>
  </div>
  <button class="btn" onclick="go('s-consent')">ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹</button>
  <button class="btn-ghost" onclick="go('s-consent')">ãƒ­ã‚°ã‚¤ãƒ³ã›ãšã«å§‹ã‚ã‚‹</button>
  <div class="spacer"></div>
</div>

<!-- ========== 2. CONSENT ========== -->
<div class="scr" id="s-consent">
  <div class="spacer"></div>
  <div class="emoji-big">âš ï¸</div>
  <div class="card card-accent">
    <p style="font-size:.88rem;font-weight:700;line-height:1.8">
      ã“ã®è¨ºæ–­ã¯<strong>åŒ»ç™‚ãƒ»æ³•å¾‹ãƒ»é‡‘èã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã§ã¯ã‚ã‚Šã¾ã›ã‚“</strong>ã€‚<br><br>
      æ§‹é€ çš„ãªå‚¾å‘ã‚’å¯è¦–åŒ–ã—ã€è¡Œå‹•ã®å„ªå…ˆåº¦ã‚’æ•´ç†ã™ã‚‹ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚<br><br>
      å€‹äººç‰¹å®šæƒ…å ±ï¼ˆæ°åãƒ»ä½æ‰€ãƒ»å‹¤å‹™å…ˆï¼‰ã¯ä¸€åˆ‡å–å¾—ã—ã¾ã›ã‚“ã€‚<br>
      çµæœã¯ãŠä½¿ã„ã®ç«¯æœ«ã«ã®ã¿ä¿å­˜ã•ã‚Œã¾ã™ã€‚
    </p>
  </div>
  <button class="btn" onclick="go('s-profile')" style="margin-top:1rem">åŒæ„ã—ã¦é€²ã‚€</button>
  <div class="spacer"></div>
</div>

<!-- ========== 3. PROFILE ========== -->
<div class="scr" id="s-profile">
  <div class="scene-label">PROFILE</div>
  <p class="narr" style="margin-bottom:1.5rem">ã‚ãªãŸã®å±æ€§ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚<br>ï¼ˆçµ±è¨ˆçš„ãªå‚¾å‘æŠŠæ¡ã«ä½¿ã„ã¾ã™ï¼‰</p>
  <div class="card" style="max-width:400px">
    <div class="profile-group">
      <div class="profile-group-label">ğŸ“… å¹´é½¢å¸¯</div>
      <div class="profile-opts" data-key="ageBand">
        <div class="profile-opt" onclick="prof('ageBand','18-24',this)">18-24</div>
        <div class="profile-opt" onclick="prof('ageBand','25-29',this)">25-29</div>
        <div class="profile-opt" onclick="prof('ageBand','30-39',this)">30-39</div>
        <div class="profile-opt" onclick="prof('ageBand','40-49',this)">40-49</div>
        <div class="profile-opt" onclick="prof('ageBand','50+',this)">50+</div>
      </div>
    </div>
    <div class="profile-group">
      <div class="profile-group-label">ğŸ“ æœ€çµ‚å­¦æ­´</div>
      <div class="profile-opts" data-key="education">
        <div class="profile-opt" onclick="prof('education','junior_high',this)">ä¸­å’</div>
        <div class="profile-opt" onclick="prof('education','high_school',this)">é«˜å’</div>
        <div class="profile-opt" onclick="prof('education','vocational',this)">å°‚é–€å’</div>
        <div class="profile-opt" onclick="prof('education','university',this)">å¤§å’+</div>
      </div>
    </div>
    <div class="profile-group">
      <div class="profile-group-label">ğŸ’¼ å°±æ¥­çŠ¶æ…‹</div>
      <div class="profile-opts" data-key="employment">
        <div class="profile-opt" onclick="prof('employment','unemployed',this)">ç„¡è·</div>
        <div class="profile-opt" onclick="prof('employment','non_regular',this)">éæ­£è¦</div>
        <div class="profile-opt" onclick="prof('employment','regular',this)">æ­£è¦</div>
        <div class="profile-opt" onclick="prof('employment','self',this)">è‡ªå–¶</div>
      </div>
    </div>
    <div class="profile-group">
      <div class="profile-group-label">ğŸ“ å±…ä½ç’°å¢ƒ</div>
      <div class="profile-opts" data-key="area">
        <div class="profile-opt" onclick="prof('area','urban',this)">éƒ½å¸‚éƒ¨</div>
        <div class="profile-opt" onclick="prof('area','suburban',this)">éƒŠå¤–</div>
        <div class="profile-opt" onclick="prof('area','rural',this)">åœ°æ–¹</div>
      </div>
    </div>
  </div>
  <button class="btn disabled" id="btn-profile" onclick="startScan()">ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹ â†’</button>
</div>

<!-- ========== 4. SCAN (questions) ========== -->
<div class="scr" id="s-scan">
  <div class="scene-label">SCAN</div>
  <div id="scanProgress" style="font-size:.75rem;font-weight:800;color:var(--dim);margin-bottom:1rem"></div>
  <div id="scanQuestions" style="width:100%;max-width:400px"></div>
  <button class="btn disabled" id="btn-scan" onclick="calcResult()" style="margin-top:1rem">è¨ºæ–­çµæœã‚’è¦‹ã‚‹ ğŸ”</button>
</div>

<!-- ========== 5. RESULT ========== -->
<div class="scr" id="s-result">
  <div class="scene-label">DIAGNOSIS RESULT</div>
  <div id="resContent" style="width:100%;max-width:420px;display:flex;flex-direction:column;align-items:center"></div>
  <div style="display:flex;flex-direction:column;align-items:center;gap:.5rem;margin-top:1.5rem">
    <button class="btn" onclick="copyResult()">ğŸ“‹ çµæœã‚’ã‚³ãƒ”ãƒ¼</button>
    <button class="btn btn-outline btn-sm" onclick="location.reload()">ã‚‚ã†ä¸€åº¦ã‚¹ã‚­ãƒ£ãƒ³</button>
  </div>
</div>

<script>
/* ========== QUESTIONS DATA ========== */
const QUESTIONS = [
  // STRUCTURE (S01-S06)
  {id:'S01',cat:'structure',text:'ç—…æ°—ã‚„å¤±æ¥­æ™‚ã€3ãƒ¶æœˆè€ãˆã‚‰ã‚Œã‚‹æ”¯æ´å…ˆãŒã‚ã‚‹'},
  {id:'S02',cat:'structure',text:'é€šé™¢/æœè–¬/ç¡çœ ãªã©å¥åº·ç¶­æŒãŒä¸€å®šã§ãã¦ã„ã‚‹'},
  {id:'S03',cat:'structure',text:'é€±40æ™‚é–“åƒã„ã¦ã‚‚æ€è€ƒãŒæ­¢ã¾ã‚‰ãªã„ä½“åŠ›ãŒæ®‹ã‚‹'},
  {id:'S04',cat:'structure',text:'è·æ¥­è¨“ç·´ã‚„æ±‚äººãŒã‚ã‚‹å ´æ‰€ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹'},
  {id:'S05',cat:'structure',text:'ä½ç’°å¢ƒãŒå­¦ç¿’ã‚„ä¼‘æ¯ã‚’å¦¨ã’ã¦ã„ãªã„'},
  {id:'S06',cat:'structure',text:'å®¶åº­å•é¡Œï¼ˆä»‹è­·/DV/è‚²å…å˜ç‹¬ãªã©ï¼‰ãŒç”Ÿæ´»ã‚’åœ§è¿«ã—ã¦ã„ãªã„'},
  // CULTURE (C01-C06)
  {id:'C01',cat:'culture',text:'æ±‚äººç¥¨ã«æ›¸ã‘ã‚‹è³‡æ ¼ãƒ»æŠ€èƒ½ãŒ1ã¤ä»¥ä¸Šã‚ã‚‹'},
  {id:'C02',cat:'culture',text:'ãã®æŠ€èƒ½ã¯ã€ŒæœªçµŒé¨“å¯å¸‚å ´ã€ã§é€šç”¨ã™ã‚‹é ˜åŸŸã '},
  {id:'C03',cat:'culture',text:'1ã¤ã®æŠ€èƒ½ã«100æ™‚é–“ä»¥ä¸Šé›†ä¸­ã—ãŸçµŒé¨“ãŒã‚ã‚‹'},
  {id:'C04',cat:'culture',text:'éå»ã«ã€Œå½¢ã«ã—ãŸæˆæœç‰©ã€ï¼ˆä½œå“/å®Ÿç¸¾/åˆæ ¼ï¼‰ãŒã‚ã‚‹'},
  {id:'C05',cat:'culture',text:'å­¦ç¿’ã¯ã€Œç„¡æ–™ã€œå®‰ä¾¡ãƒ«ãƒ¼ãƒˆã€ã‚’ä½¿ã„å€’ã—ã¦ã„ã‚‹'},
  {id:'C06',cat:'culture',text:'ç›´è¿‘30æ—¥ã§å­¦ç¿’æ™‚é–“ã‚’ç¢ºä¿ã—ã¦ã„ã‚‹ï¼ˆé€±3æ—¥ä»¥ä¸Šï¼‰'},
  // SOCIAL (R01-R06)
  {id:'R01',cat:'social',text:'è‡ªåˆ†ã‚ˆã‚Šä¸€æ®µä¸Šã®äººã¨è©±ã™æ©Ÿä¼šãŒã‚ã‚‹ï¼ˆæœˆ1ä»¥ä¸Šï¼‰'},
  {id:'R02',cat:'social',text:'åŒã˜å¢ƒé‡ã®ä»²é–“ï¼ˆæ¨ªã®é€£å¸¯ï¼‰ãŒã„ã‚‹'},
  {id:'R03',cat:'social',text:'å…¬çš„æ”¯æ´æ©Ÿé–¢ï¼ˆãƒãƒ­ãƒ¯ç­‰ï¼‰ã§æ‹…å½“è€…ã¨é–¢ä¿‚ãŒã§ãã¦ã„ã‚‹'},
  {id:'R04',cat:'social',text:'æƒ…å ±æºãŒSNSã ã‘ã«ãªã£ã¦ã„ãªã„'},
  {id:'R05',cat:'social',text:'å‹‰å¼·ä¼š/è¨“ç·´/ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã«å‚åŠ ã—ãŸã“ã¨ãŒã‚ã‚‹'},
  {id:'R06',cat:'social',text:'ç›¸è«‡ã§ãã‚‹ç¬¬ä¸‰è€…ãŒæœ€ä½1äººã„ã‚‹'},
  // ECONOMIC (E01-E06)
  {id:'E01',cat:'economic',text:'æœˆ5000å††ã‚’æœªæ¥æŠ•è³‡ã«å›ã›ã‚‹'},
  {id:'E02',cat:'economic',text:'å¨¯æ¥½/å—œå¥½è²»ã‚’å‰Šã£ãŸå®Ÿç¸¾ãŒã‚ã‚‹'},
  {id:'E03',cat:'economic',text:'å›ºå®šè²»ï¼ˆé€šä¿¡/å®¶è³ƒ/ã‚µãƒ–ã‚¹ã‚¯ï¼‰ã‚’è¦‹ç›´ã—ãŸã“ã¨ãŒã‚ã‚‹'},
  {id:'E04',cat:'economic',text:'æ»ç´ã‚„å»¶æ»ãŒãªã„'},
  {id:'E05',cat:'economic',text:'åæ”¯ã‚’æŠŠæ¡ã—ã¦ã„ã‚‹ï¼ˆå®¶è¨ˆç°¿/ãƒ¡ãƒ¢ã§ã‚‚ï¼‰'},
  {id:'E06',cat:'economic',text:'å€Ÿé‡‘/è¿”æ¸ˆãŒåˆ¤æ–­åŠ›ã‚’å¥ªã£ã¦ã„ãªã„'},
  // MENTAL (M01-M06)
  {id:'M01',cat:'mental',text:'å¤±æ•—ã‚’äººæ ¼ã§ãªãæ§‹é€ ã§èª¬æ˜ã§ãã‚‹'},
  {id:'M02',cat:'mental',text:'ç›®å…ˆã®å¿«æ¥½ã‚’æˆ‘æ…¢ã—ãŸçµŒé¨“ãŒã‚ã‚‹ï¼ˆçŸ­æœŸâ†’é•·æœŸï¼‰'},
  {id:'M03',cat:'mental',text:'ã€Œã©ã†ã›ç„¡ç†ã€ãŒå£ç™–ã«ãªã£ã¦ã„ãªã„'},
  {id:'M04',cat:'mental',text:'æƒ…å ±åé›†ã§æº€è¶³ã›ãšã€1ã¤ã‚’å®Œèµ°ã§ãã‚‹'},
  {id:'M05',cat:'mental',text:'è‡ªå°Šå¿ƒã®æ‹ ç‚¹ï¼ˆå±…å ´æ‰€ï¼‰ãŒæœ€ä½1ã¤ã‚ã‚‹'},
  {id:'M06',cat:'mental',text:'ä¸å®‰ãŒå¼·ã„æ™‚ã§ã‚‚å°ã•ãè¡Œå‹•ã§ãã‚‹'},
];

const CAT_META = {
  structure:{name:'æ§‹é€ ',emoji:'ğŸ—ï¸',color:'var(--cat-s)',weight:1.3},
  culture:{name:'æŠ€èƒ½',emoji:'âš¡',color:'var(--cat-c)',weight:1.0},
  social:{name:'ç¸',emoji:'ğŸ¤',color:'var(--cat-r)',weight:0.9},
  economic:{name:'ç®¡ç†',emoji:'ğŸ’°',color:'var(--cat-e)',weight:1.0},
  mental:{name:'ãƒ¡ãƒ³ã‚¿ãƒ«',emoji:'ğŸ§ ',color:'var(--cat-m)',weight:1.5},
};

const TYPE_DATA = {
  EFFORT_IMPOSSIBLE:{
    label:'åŠªåŠ›ä¸èƒ½',gradient:'linear-gradient(135deg,#FF5757,#FF8C42)',emoji:'ğŸš¨',
    headline:'åŠªåŠ›ã‚’å§‹ã‚ã‚‹å‰ã«ã€ç’°å¢ƒã‚’ç«‹ã¦ç›´ã™ã¹ãçŠ¶æ…‹',
    summary:'ä»Šã¯åŠªåŠ›ãŒæˆæœã«å¤‰ã‚ã‚Šã«ãã„æ§‹é€ ã«ã„ã‚‹ã€‚ä½“åŠ›ãƒ»ä½ç’°å¢ƒãƒ»å®¶åº­ã®åœ§è¿«ãªã©ã€ç”Ÿæ´»åŸºç›¤ãã®ã‚‚ã®ãŒä¸å®‰å®šãªçŠ¶æ…‹ã ã€‚ã“ã“ã§ç„¡ç†ã«é ‘å¼µã‚‹ã¨å¿ƒã ã‘ãŒå‰Šã‚Œã‚‹ã€‚ã¾ãšã€Œå›å¾©ã€ã¨ã€Œç’°å¢ƒã®å†è¨­è¨ˆã€ãŒæœ€å„ªå…ˆã€‚åŠªåŠ›ã¯ã€åœŸå°ãŒã§ãã¦ã‹ã‚‰ã§ã„ã„ã€‚',
  },
  EFFORT_WASTE:{
    label:'åŠªåŠ›æµªè²»',gradient:'linear-gradient(135deg,#FF8C42,#FFD166)',emoji:'ğŸ”„',
    headline:'åŠªåŠ›ã¯ã—ã¦ã„ã‚‹ãŒã€æ–¹å‘ãŒå¸‚å ´ã«å±Šã„ã¦ã„ãªã„',
    summary:'ã‚ãªãŸã¯ã‚µãƒœã£ã¦ã„ãªã„ã€‚ã‚€ã—ã‚å‹•ã„ã¦ã„ã‚‹ã€‚ãŸã ã€åŠªåŠ›ã®æ–¹å‘ãŒã€Œå¸‚å ´ã§è©•ä¾¡ã•ã‚Œã‚‹å½¢ã€ã«å¤‰æ›ã•ã‚Œã¦ã„ãªã„ã€‚æŠ€èƒ½ãŒæ•£ã£ãŸã¾ã¾ã‹ã€äººã¨ã®ã¤ãªãŒã‚ŠãŒè¶³ã‚Šãªã„ã‹ã€ã‚ã‚‹ã„ã¯ãã®ä¸¡æ–¹ã ã€‚ã‚„ã‚‹ã“ã¨ã‚’ã€Œç‹­ã‚ã¦ã€å½¢ã«ã™ã‚‹ã€ã ã‘ã§å¤§ããå¤‰ã‚ã‚‹ã€‚',
  },
  RISE_POSSIBLE:{
    label:'ä¸Šæ˜‡å¯èƒ½',gradient:'linear-gradient(135deg,#4ECDC4,#06D6A0)',emoji:'ğŸ“ˆ',
    headline:'é…ç½®ã¯æ•´ã„å§‹ã‚ã¦ã„ã‚‹ã€‚90æ—¥ã§ä¼¸ã°ã›ã‚‹',
    summary:'åŸºç›¤ã¯ã‚ã‚‹ã€‚ãƒ¡ãƒ³ã‚¿ãƒ«ã‚‚æŠ˜ã‚Œã¦ã„ãªã„ã€‚ã‚ã¨ã¯ã€Œä¼¸ã³ã—ã‚ãŒä¸€ç•ªå¤§ãã„ã‚«ãƒ†ã‚´ãƒªã€ã«90æ—¥é›†ä¸­ã™ã‚‹ã“ã¨ã€‚å¼±ã„ã¨ã“ã‚ã‚’å…¨éƒ¨ç›´ãã†ã¨ã—ãªã„ã€‚ä¸€ç•ªåŠ¹ãã¨ã“ã‚ã«ç«åŠ›ã‚’é›†ä¸­ã•ã›ã‚Œã°ã€æµã‚ŒãŒå¤‰ã‚ã‚‹ã€‚',
  },
  EXIT_SOON:{
    label:'è„±å‡ºç›´å‰',gradient:'linear-gradient(135deg,#06D6A0,#4ECDC4)',emoji:'ğŸš€',
    headline:'è„±å‡ºã¯è¿‘ã„ã€‚ã‚ã¨ã¯"ã‚„ã‚Šåˆ‡ã‚‹èƒ†åŠ›"ã ã‘',
    summary:'æ§‹é€ ãƒ»æŠ€èƒ½ãƒ»ãƒ¡ãƒ³ã‚¿ãƒ«ãŒãã‚ã£ã¦ã„ã‚‹ã€‚ã‚ãªãŸã«è¶³ã‚Šãªã„ã®ã¯ã€Œæœ€å¾Œã®ä¸€æŠ¼ã—ã€ã ã‘ã ã€‚å®Œç’§ã‚’å¾…ãŸãšã€8å‰²ã§å‡ºã™ã€‚å½¢ã«ã—ã¦äººã«è¦‹ã›ã‚‹ã€‚ãã“ã‹ã‚‰ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãŒå›ã‚Šå§‹ã‚ã‚‹ã€‚',
  },
};

/* ========== ACTIONS DB ========== */
const ACTIONS = [
  // structure
  {id:'A01',tags:['structure'],title:'ç”Ÿæ´»ã®ã€Œå›å¾©ã€ã‚’æœ€å„ªå…ˆã«ã™ã‚‹',
    detail:'ç¡çœ ãƒ»é€šé™¢ãƒ»é£Ÿäº‹ã®æœ€ä½ãƒ©ã‚¤ãƒ³ã‚’å›ºå®šã™ã‚‹ï¼ˆé€±ã®ãƒ«ãƒ¼ãƒ«åŒ–ï¼‰',
    why:'ä½“åŠ›ãŒãªã„çŠ¶æ…‹ã®åŠªåŠ›ã¯ã€æˆæœãŒå‡ºãšã«å¿ƒã ã‘å‰Šã‚Œã‚‹'},
  {id:'A02',tags:['structure'],title:'ä½ç’°å¢ƒã®å®‰å…¨ç¢ºä¿ã‚’ç›¸è«‡ã™ã‚‹',
    detail:'è‡ªæ²»ä½“ã®ç¦ç¥‰çª“å£/DVç›¸è«‡/ç¤¾å”ã«é€£çµ¡ã™ã‚‹',
    why:'ç’°å¢ƒãŒå£Šã‚ŒãŸã¾ã¾åŠªåŠ›ã—ã¦ã‚‚ã€å£Šã‚Œç¶šã‘ã‚‹'},
  {id:'A03',tags:['structure'],title:'ç”Ÿæ´»ä¿è­·/ç·Šæ€¥å°å£è³‡é‡‘ã‚’èª¿ã¹ã‚‹',
    detail:'ä½ã‚“ã§ã„ã‚‹è‡ªæ²»ä½“ã®ç¦ç¥‰èª²ã«é›»è©±1æœ¬ã™ã‚‹',
    why:'ä½¿ãˆã‚‹åˆ¶åº¦ã‚’çŸ¥ã‚‰ãªã„ã ã‘ã§è©°ã‚€äººã¯å¤šã„'},
  // culture
  {id:'A11',tags:['culture','culture_beginner'],title:'ãƒãƒ­ãƒ¼ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’1ä»¶èª¿ã¹ã‚‹',
    detail:'è‡ªæ²»ä½“ã‚µã‚¤ãƒˆ/ãƒãƒ­ãƒ¯ã§ã€IT/é›»æ°—/æº¶æ¥/ä»‹è­·ã®è¨“ç·´ã‚’ç¢ºèª',
    why:'ç„¡æ–™ã§å¸‚å ´ä¾¡å€¤ã«ç›´çµã™ã‚‹ã€Œå›½ç­–ãƒ«ãƒ¼ãƒˆã€ãŒã‚ã‚‹'},
  {id:'A12',tags:['culture'],title:'1ã¤ã®æŠ€èƒ½ã«30æ—¥é›†ä¸­ã™ã‚‹',
    detail:'ä»ŠæŒã£ã¦ã„ã‚‹æŠ€èƒ½ã§ã€Œå°ã•ãªæˆæœç‰©ã€ã‚’1ã¤å®Œæˆã•ã›ã‚‹',
    why:'æ•£ã‚‰ã‹ã£ãŸåŠªåŠ›ã¯è©•ä¾¡ã•ã‚Œãªã„ã€‚å½¢ã«ã—ãŸã‚‚ã®ã ã‘ãŒæ­¦å™¨ã«ãªã‚‹'},
  {id:'A13',tags:['culture','collector'],title:'æƒ…å ±åé›†ã‚’ã‚„ã‚ã¦æ‰‹ã‚’å‹•ã‹ã™',
    detail:'ã€Œèª¿ã¹ã‚‹ã€ã‚’ç¦æ­¢ã—ã¦ã€Œä½œã‚‹/æ›¸ã/å‡ºã™ã€ã ã‘ã®æ—¥ã‚’é€±2ä½œã‚‹',
    why:'çŸ¥è­˜ã¯æ­¦å™¨ã˜ã‚ƒãªã„ã€‚å®Œæˆç‰©ã ã‘ãŒæ­¦å™¨'},
  // social
  {id:'A21',tags:['social','social_public'],title:'ã‚¸ãƒ§ãƒ–ãƒ»ã‚«ãƒ¼ãƒ‰ç›¸è«‡ã‚’äºˆç´„ã™ã‚‹',
    detail:'ãƒãƒ­ãƒ¯ã§è·æ¥­è¨“ç·´ã¨è·æ­´æ•´ç†ã®å°ç·šã‚’ä½œã‚‹',
    why:'äººã‚’ä½¿ã„å€’ã™ã¨ã€æƒ…å ±ã¨æ©Ÿä¼šãŒå¢—ãˆã‚‹'},
  {id:'A22',tags:['social'],title:'æœˆ1ã§ã€Œä¸€æ®µä¸Šã®äººã€ã¨æ¥ç‚¹ã‚’ä½œã‚‹',
    detail:'å‹‰å¼·ä¼š/ã‚»ãƒŸãƒŠãƒ¼/ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã«1ã¤å‚åŠ ã™ã‚‹',
    why:'åŒã˜å±¤ã®ä¸­ã ã‘ã§ã¯æƒ…å ±ãŒå¾ªç’°ã—ãªã„'},
  {id:'A23',tags:['social'],title:'SNSä»¥å¤–ã®æƒ…å ±æºã‚’1ã¤ç¢ºä¿ã™ã‚‹',
    detail:'å›³æ›¸é¤¨/å°‚é–€ã‚µã‚¤ãƒˆ/å…¬çš„ãƒ‡ãƒ¼ã‚¿ã‚’å®šæœŸçš„ã«è¦‹ã‚‹ç¿’æ…£ã‚’ä½œã‚‹',
    why:'SNSã¯æ„Ÿæƒ…ã‚’å‹•ã‹ã™ãŒã€è¡Œå‹•ã‚’æ­£ã—ãã¯ã—ãªã„'},
  // economic
  {id:'A31',tags:['economic','debt'],title:'è¿”æ¸ˆ/æ»ç´ã®ç›¸è«‡å°ç·šã‚’ç¢ºä¿ã™ã‚‹',
    detail:'æ³•ãƒ†ãƒ©ã‚¹/è‡ªæ²»ä½“çª“å£/æ¶ˆè²»ç”Ÿæ´»ã‚»ãƒ³ã‚¿ãƒ¼ã‚’èª¿ã¹ã‚‹',
    why:'é‡‘ã®ä¸å®‰ã¯åˆ¤æ–­ã‚’å£Šã™ã€‚ã¾ãšæ€è€ƒã®å›å¾©ãŒå¿…è¦'},
  {id:'A32',tags:['economic'],title:'æœˆ5000å††ã®ã€ŒæŠ€èƒ½æŠ•è³‡æ ã€ã‚’å›ºå®šã™ã‚‹',
    detail:'å¨¯æ¥½è²»ã‚’1ã¤å‰Šã£ã¦ã€å­¦ç¿’/è³‡æ ¼/äº¤é€šè²»ã«å›ã™',
    why:'å°ã•ã„æŠ•è³‡ã®ç©ã¿é‡ã­ãŒã€1å¹´å¾Œã®é¸æŠè‚¢ã‚’å¤‰ãˆã‚‹'},
  {id:'A33',tags:['economic'],title:'å›ºå®šè²»ã‚’1ã¤ã ã‘è¦‹ç›´ã™',
    detail:'é€šä¿¡è²»/ã‚µãƒ–ã‚¹ã‚¯/ä¿é™ºã‚’1ã¤ã ã‘æœ€å®‰ã«å¤‰ãˆã‚‹',
    why:'æ¯æœˆè‡ªå‹•ã§å¤±ã†é‡‘ã‚’æ­¢ã‚ã‚‹ã®ãŒæœ€ã‚‚ã‚³ã‚¹ãƒ‘ãŒé«˜ã„'},
  // mental
  {id:'A41',tags:['mental'],title:'å¤±æ•—ã‚’ã€Œæ§‹é€ ãƒ¡ãƒ¢ã€ã«æ›¸ãæ›ãˆã‚‹',
    detail:'ã€Œè‡ªåˆ†ãŒãƒ€ãƒ¡ã€â†’ã€Œä½•ã®ä»•çµ„ã¿ãŒè¶³ã‚Šãªã‹ã£ãŸï¼Ÿã€ã¨æ›¸ãç›´ã™',
    why:'äººæ ¼å¦å®šã¯å­¦ç¿’ã‚’æ­¢ã‚ã‚‹ã€‚æ§‹é€ åˆ†æã¯æ¬¡ã®æ‰“ã¡æ‰‹ã‚’ç”Ÿã‚€'},
  {id:'A42',tags:['mental'],title:'é€±ã«1ã¤ã ã‘ã€Œå®Œèµ°ã€ã™ã‚‹ç¿’æ…£ã‚’ä½œã‚‹',
    detail:'å°ã•ãã¦ã„ã„ã€‚å§‹ã‚ãŸã“ã¨ã‚’1ã¤æœ€å¾Œã¾ã§ã‚„ã‚Šåˆ‡ã‚‹',
    why:'å®Œèµ°ä½“é¨“ãŒãªã„ã¨ã€è‡ªå·±åŠ¹åŠ›æ„ŸãŒæ¯ã‚Œã‚‹'},
];

/* ========== STATE ========== */
const profileData = {};
const answers = {};
let profileDone = 0;
let user = null;

/* ========== NAV ========== */
function go(id){
  document.querySelectorAll('.scr').forEach(s=>s.classList.remove('on'));
  document.getElementById(id).classList.add('on');
  window.scrollTo({top:0});
  updateProg(id);
}
const progMap={'s-start':0,'s-consent':5,'s-profile':10,'s-scan':15,'s-result':100};
function updateProg(id){document.getElementById('prog').style.width=(progMap[id]||0)+'%'}

/* ========== GOOGLE LOGIN (optional) ========== */
function googleLogin(){
  // For GitHub Pages: requires Google Identity Services setup
  // Placeholder - stores mock user in localStorage
  // To enable real Google login, add your Google Client ID and GSI script
  const name = prompt('è¡¨ç¤ºåã‚’å…¥åŠ›ï¼ˆGoogleãƒ­ã‚°ã‚¤ãƒ³ã¯è¦Client IDè¨­å®šï¼‰ï¼š');
  if(name){
    user = {name};
    document.getElementById('loginStatus').textContent = 'âœ“ ' + name + ' ã§ãƒ­ã‚°ã‚¤ãƒ³ä¸­';
    document.getElementById('loginBtn').style.display = 'none';
    localStorage.setItem('pbs_user', JSON.stringify(user));
  }
}
// Restore on load
try{
  const saved = localStorage.getItem('pbs_user');
  if(saved){user=JSON.parse(saved);
    document.getElementById('loginStatus').textContent='âœ“ '+user.name+' ã§ãƒ­ã‚°ã‚¤ãƒ³ä¸­';
    document.getElementById('loginBtn').style.display='none';
  }
}catch(e){}

/* ========== PROFILE ========== */
function prof(key,val,el){
  profileData[key]=val;
  el.parentElement.querySelectorAll('.profile-opt').forEach(o=>o.classList.remove('sel'));
  el.classList.add('sel');
  if(Object.keys(profileData).length>=4)
    document.getElementById('btn-profile').classList.remove('disabled');
}

/* ========== BUILD QUESTIONS ========== */
function startScan(){
  go('s-scan');
  const wrap = document.getElementById('scanQuestions');
  wrap.innerHTML = '';
  let currentCat = '';
  QUESTIONS.forEach((q,i) => {
    if(q.cat !== currentCat){
      currentCat = q.cat;
      const m = CAT_META[q.cat];
      const answered = QUESTIONS.filter(x=>x.cat===q.cat&&answers[x.id]!==undefined).length;
      wrap.innerHTML += `<div class="cat-header" id="cat-${q.cat}">
        <div class="cat-dot" style="background:${m.color}"></div>
        <div class="cat-name" style="color:${m.color}">${m.emoji} ${m.name}</div>
        <div class="cat-count" id="cnt-${q.cat}">0 / 6</div>
      </div>`;
    }
    wrap.innerHTML += `<div class="q-card" id="qcard-${q.id}">
      <div class="q-num" style="color:${CAT_META[q.cat].color}">${q.id}</div>
      <div class="q-text">${q.text}</div>
      <div class="q-opts">
        <div class="q-opt" onclick="ans('${q.id}',0,this)">ã„ã„ãˆ</div>
        <div class="q-opt" onclick="ans('${q.id}',1,this)">ä¸€éƒ¨</div>
        <div class="q-opt" onclick="ans('${q.id}',2,this)">ã¯ã„</div>
      </div>
    </div>`;
  });
  updateScanProgress();
}

function ans(id,val,el){
  answers[id]=val;
  el.parentElement.querySelectorAll('.q-opt').forEach(o=>o.classList.remove('sel'));
  el.classList.add('sel');
  document.getElementById('qcard-'+id).classList.add('answered');
  updateScanProgress();
}

function updateScanProgress(){
  const total = QUESTIONS.length;
  const done = Object.keys(answers).length;
  document.getElementById('scanProgress').textContent = `${done} / ${total} å›ç­”æ¸ˆã¿`;
  const pct = 15 + Math.round((done/total)*80);
  document.getElementById('prog').style.width = pct+'%';
  // Update category counts
  Object.keys(CAT_META).forEach(cat=>{
    const qs = QUESTIONS.filter(q=>q.cat===cat);
    const cnt = qs.filter(q=>answers[q.id]!==undefined).length;
    const el = document.getElementById('cnt-'+cat);
    if(el) el.textContent = `${cnt} / ${qs.length}`;
  });
  // Enable button
  if(done>=total) document.getElementById('btn-scan').classList.remove('disabled');
  else document.getElementById('btn-scan').classList.add('disabled');
}

/* ========== SCORING ========== */
function calcResult(){
  // 1. Category scores (0-100)
  const catScores = {};
  Object.keys(CAT_META).forEach(cat=>{
    const qs = QUESTIONS.filter(q=>q.cat===cat);
    const raw = qs.reduce((s,q)=>(s+(answers[q.id]||0)),0);
    const maxRaw = qs.length * 2;
    catScores[cat] = Math.round((raw/maxRaw)*100);
  });

  // 2. Overall (weighted)
  const W = Object.values(CAT_META).reduce((s,m)=>s+m.weight,0);
  let weightedSum = 0;
  Object.keys(CAT_META).forEach(cat=>{
    weightedSum += catScores[cat] * CAT_META[cat].weight;
  });
  const overall = Math.round(weightedSum/W);

  // 3. Penalty / Flags
  const structGateItems = ['S02','S03','S05','S06'];
  const zeroCount = structGateItems.filter(id=>(answers[id]||0)===0).length;
  const structureGate = catScores.structure <= 30 || zeroCount >= 2;

  const collectorFlag = (answers.C03||0)<=1 && (answers.M04||0)<=1 && (answers.C06||0)<=1;
  const debtStressFlag = (answers.E04||0)===0 || (answers.E06||0)===0;

  // 4. Type
  let type;
  if(structureGate){
    type='EFFORT_IMPOSSIBLE';
  } else if(overall<55 && (catScores.culture<55||catScores.social<45) && catScores.mental>=40){
    type='EFFORT_WASTE';
  } else if(overall>=75 && catScores.mental>=60 && catScores.culture>=60){
    type='EXIT_SOON';
  } else if(overall>=55 && catScores.mental>=45 && catScores.structure>=40){
    type='RISE_POSSIBLE';
  } else {
    // Tiebreak: mental low â†’ worse type
    if(catScores.mental<40) type='EFFORT_IMPOSSIBLE';
    else if(overall<55) type='EFFORT_WASTE';
    else type='RISE_POSSIBLE';
  }

  // 5. Category feedback
  const catFeedback = {};
  Object.keys(CAT_META).forEach(cat=>{
    const s = catScores[cat];
    let level,strength,gap;
    if(s>=80){level='å¼·ã„';strength='ã“ã®é ˜åŸŸã¯å®‰å®šã—ã¦ã„ã‚‹ã€‚ç¶­æŒã‚’ç¶šã‘ã‚ˆã†ã€‚';gap='ç¾çŠ¶ç¶­æŒã§OKã€‚ä»–ã«ç«åŠ›ã‚’å›ã›ã‚‹ã€‚';}
    else if(s>=55){level='ä¼¸ã³ã‚‹';strength='åŸºç›¤ã¯ã‚ã‚‹ã€‚é›†ä¸­ã™ã‚Œã°ä¼¸ã³ã‚‹é ˜åŸŸã€‚';gap='ã‚ã¨ä¸€æ­©ã€‚90æ—¥ã§å¤§ããå¤‰ãˆã‚‰ã‚Œã‚‹ã€‚';}
    else if(s>=30){level='å¼±ã„';strength='æ„è­˜ã¯ã‚ã‚‹ã€‚ãŸã ã—å½¢ã«ãªã£ã¦ã„ãªã„ã€‚';gap='ã“ã“ãŒãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã€‚å„ªå…ˆçš„ã«æ‰‹å½“ãŒå¿…è¦ã€‚';}
    else{level='å±é™º';strength='ã»ã¼æ©Ÿèƒ½ã—ã¦ã„ãªã„ã€‚';gap='æœ€å„ªå…ˆã§ç’°å¢ƒã”ã¨è¦‹ç›´ã™å¿…è¦ãŒã‚ã‚‹ã€‚';}
    catFeedback[cat]={level,strength,gap,score:s};
  });

  // 6. Actions (max 3)
  const selectedActions = [];
  if(structureGate){
    selectedActions.push(...ACTIONS.filter(a=>a.tags.includes('structure')).slice(0,3));
  } else {
    if(debtStressFlag){
      const da = ACTIONS.find(a=>a.tags.includes('debt'));
      if(da) selectedActions.push(da);
    }
    // Lowest category
    const sorted = Object.entries(catScores).filter(([k])=>k!=='structure'||!structureGate)
      .sort((a,b)=>a[1]-b[1]);
    const lowestCat = sorted[0][0];
    const catActions = ACTIONS.filter(a=>a.tags.includes(lowestCat)&&!selectedActions.find(s=>s.id===a.id));
    selectedActions.push(...catActions.slice(0, 3-selectedActions.length));
    if(collectorFlag && selectedActions.length<3){
      const ca = ACTIONS.find(a=>a.tags.includes('collector')&&!selectedActions.find(s=>s.id===a.id));
      if(ca) selectedActions.push(ca);
    }
    // Fill to 3
    while(selectedActions.length<3){
      const next = ACTIONS.find(a=>!selectedActions.find(s=>s.id===a.id));
      if(next) selectedActions.push(next);
      else break;
    }
  }

  // 7. Build collector/debt addendum
  let addendum = '';
  if(collectorFlag) addendum += '\n\nâš ï¸ å­¦ç¿’é€ƒé¿ã®å‚¾å‘ã‚ã‚Šï¼šæƒ…å ±åé›†ã§å®‰å¿ƒã—ã¦ã„ã‚‹ãŒã€æ‰‹ãŒå‹•ã„ã¦ã„ãªã„ã€‚ã€Œèª¿ã¹ã‚‹ã€ã‚’æ¸›ã‚‰ã—ã€Œä½œã‚‹ã€ã‚’å¢—ã‚„ã™ã“ã¨ãŒæœ€å„ªå…ˆã€‚';
  if(debtStressFlag) addendum += '\n\nâš ï¸ è² å‚µã‚¹ãƒˆãƒ¬ã‚¹æ¤œå‡ºï¼šé‡‘éŠ­çš„ãªä¸å®‰ãŒåˆ¤æ–­åŠ›ã‚’å¥ªã£ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã€‚è¿”æ¸ˆã®ç›¸è«‡å°ç·šã‚’ç¢ºä¿ã™ã‚‹ã“ã¨ã§ã€æ€è€ƒã®å›å¾©ãŒå§‹ã¾ã‚‹ã€‚';

  renderResult(type, catScores, catFeedback, overall, selectedActions, addendum);
  saveHistory(type, catScores, overall);
}

/* ========== RENDER RESULT ========== */
function renderResult(type, catScores, catFeedback, overall, actions, addendum){
  const t = TYPE_DATA[type];
  const wrap = document.getElementById('resContent');

  // Confetti for good results
  if(type==='EXIT_SOON'||type==='RISE_POSSIBLE') spawnConfetti();

  let html = '';
  html += `<div class="res-type-badge" style="background:${t.gradient}">${t.emoji} ${t.label}</div>`;
  html += `<div class="res-headline">${t.headline}</div>`;

  // Summary
  html += `<div class="card" style="margin-bottom:1.2rem"><p style="font-size:.88rem;line-height:1.9">${t.summary}${addendum.replace(/\n/g,'<br>')}</p></div>`;

  // Bar chart
  html += `<div style="width:100%;margin-bottom:1.2rem">`;
  Object.entries(catScores).forEach(([cat,score])=>{
    const m = CAT_META[cat];
    const fb = catFeedback[cat];
    const levelColor = score>=80?'var(--green)':score>=55?'var(--blue)':score>=30?'var(--orange)':'var(--red)';
    html += `<div class="bar-row">
      <div class="bar-icon">${m.emoji}</div>
      <div class="bar-label">${m.name}</div>
      <div class="bar-track"><div class="bar-fill" style="width:${score}%;background:${m.color}"></div></div>
      <div class="bar-level" style="color:${levelColor}">${fb.level}</div>
    </div>`;
  });
  html += `</div>`;

  // Category feedback
  html += `<div class="card" style="margin-bottom:1.2rem">
    <div class="label" style="color:var(--pink)">ğŸ“Š ã‚«ãƒ†ã‚´ãƒªè©³ç´°</div>`;
  Object.entries(catFeedback).forEach(([cat,fb])=>{
    const m = CAT_META[cat];
    html += `<div style="margin-bottom:.8rem;padding-left:.6rem;border-left:3px solid ${m.color}">
      <div style="font-size:.8rem;font-weight:800;color:${m.color}">${m.emoji} ${m.name}</div>
      <div style="font-size:.8rem;color:var(--dim);line-height:1.6">${fb.gap}</div>
    </div>`;
  });
  html += `</div>`;

  // Actions
  html += `<div class="label" style="color:var(--green)">ğŸ¯ 90æ—¥ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆ${actions.length}ã¤ã ã‘ï¼‰</div>`;
  actions.forEach((a,i)=>{
    html += `<div class="action-card">
      <div class="action-num">ACTION ${i+1}</div>
      <div class="action-title">${a.title}</div>
      <div class="action-detail">${a.detail}</div>
      <div class="action-why">â†’ ${a.why}</div>
    </div>`;
  });

  // Disclaimer
  html += `<div class="disclaimer">
    âš ï¸ ã“ã®è¨ºæ–­ã¯åŒ»ç™‚ãƒ»æ³•å¾‹ãƒ»é‡‘èã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚æ§‹é€ çš„ãªå‚¾å‘ã‚’å¯è¦–åŒ–ã—ã€è¡Œå‹•ã®å„ªå…ˆåº¦ã‚’æ•´ç†ã™ã‚‹ãŸã‚ã®ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚æ·±åˆ»ãªçŠ¶æ³ã«ã‚ã‚‹æ–¹ã¯ã€å°‚é–€å®¶ã‚„å…¬çš„æ©Ÿé–¢ã«ã”ç›¸è«‡ãã ã•ã„ã€‚
  </div>`;

  wrap.innerHTML = html;

  // Store for copy
  window._resultData = {type,t,actions};
  go('s-result');
}

/* ========== SAVE HISTORY (localStorage) ========== */
function saveHistory(type,catScores,overall){
  try{
    const hist = JSON.parse(localStorage.getItem('pbs_history')||'[]');
    hist.unshift({
      date:new Date().toISOString().slice(0,10),
      type, overall,
      scores:catScores
    });
    if(hist.length>10) hist.length=10;
    localStorage.setItem('pbs_history',JSON.stringify(hist));
  }catch(e){}
}

/* ========== COPY RESULT ========== */
function copyResult(){
  const d = window._resultData;
  if(!d) return;
  const text = `ã€è²§ä¹ã‚¹ã‚­ãƒ£ãƒ³è¨ºæ–­çµæœã€‘\nã‚¿ã‚¤ãƒ—ï¼š${d.t.label}\n${d.t.headline}\n\n90æ—¥ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼š\n${d.actions.map((a,i)=>`${i+1}. ${a.title}`).join('\n')}\n\n#è²§ä¹ã‚¹ã‚­ãƒ£ãƒ³`;
  if(navigator.clipboard&&navigator.clipboard.writeText){
    navigator.clipboard.writeText(text).then(()=>showToast('ğŸ“‹ ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ')).catch(()=>fallbackCopy(text));
  } else fallbackCopy(text);
}
function fallbackCopy(text){
  const ta=document.createElement('textarea');ta.value=text;ta.style.cssText='position:fixed;left:-9999px';
  document.body.appendChild(ta);ta.select();
  try{document.execCommand('copy');showToast('ğŸ“‹ ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ')}catch(e){prompt('çµæœï¼š',text)}
  document.body.removeChild(ta);
}
function showToast(msg){
  const t=document.getElementById('toast');t.textContent=msg;
  t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2000);
}

/* ========== CONFETTI ========== */
function spawnConfetti(){
  const wrap=document.createElement('div');wrap.className='confetti-wrap';document.body.appendChild(wrap);
  const colors=['#FF6B8A','#FF8C42','#FFD166','#06D6A0','#4ECDC4','#A88BEB'];
  for(let i=0;i<40;i++){
    const c=document.createElement('div');c.className='confetti';
    c.style.left=Math.random()*100+'%';
    c.style.background=colors[Math.floor(Math.random()*colors.length)];
    c.style.animationDelay=Math.random()*1.5+'s';
    c.style.animationDuration=(2+Math.random()*1.5)+'s';
    c.style.width=(6+Math.random()*8)+'px';
    c.style.height=(6+Math.random()*8)+'px';
    c.style.borderRadius=Math.random()>.5?'50%':'2px';
    wrap.appendChild(c);
  }
  setTimeout(()=>wrap.remove(),4000);
}

/* ========== DISABLE CLICKS ON .disabled ========== */
document.addEventListener('click',e=>{
  if(e.target.classList.contains('disabled')){e.preventDefault();e.stopPropagation()}
},true);
</script>
</body>
</html>
